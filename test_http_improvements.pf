// Test HTTP Module Improvements

println("Testing HTTP Module Improvements...")

// Test 1: Create server with configuration
let server = Http.createServer()

server.config({
    cors: true,
    jsonLimit: "5MB",
    defaultHeaders: {"X-Powered-By": "Polyloft"}
})

server.log("Server configured successfully")

// Test 2: Global middleware
server.use((req, res, next) => do
    server.log("Request received: #{req.method} #{req.path}", "info")
    next()
end)

// Test 3: Error handler
server.onError((err, req, res) => do
    server.log("Error occurred: #{err}", "error")
    res.error(500, "Internal Server Error")
end)

// Test 4: Route with middleware array
def requireAuth(req, res, next):
    let token = req.headers.Authorization
    if token:
        next()
    else:
        res.status(401).json({error: "Unauthorized"})
    end
end

def logRequest(req, res, next):
    server.log("Authenticated request to #{req.path}")
    next()
end

server.get("/admin", [requireAuth, logRequest], (req, res) => do
    res.ok({message: "Admin area", data: "Secret info"})
end)

// Test 5: Response shortcuts
server.get("/ok", (req, res) => do
    res.ok({status: "success", data: [1, 2, 3]})
end)

server.post("/users", (req, res) => do
    let newUser = {id: 1, name: req.body.name}
    res.created(newUser)
end)

server.delete("/users/:id", (req, res) => do
    res.noContent()
end)

server.get("/not-found", (req, res) => do
    res.notFound("Resource not found")
end)

server.get("/custom-error", (req, res) => do
    res.error(503, "Service temporarily unavailable")
end)

// Test 6: Test JSON parsing in client
println("\nTesting HTTP Client improvements...")

// The server needs to be running for this test
// For now, we'll just verify the API exists
println("Http.get API exists: #{Http.get != nil}")
println("Http.post API exists: #{Http.post != nil}")
println("Http.put API exists: #{Http.put != nil}")
println("Http.delete API exists: #{Http.delete != nil}")
println("Http.request API exists: #{Http.request != nil}")

// Test 7: Start server
let serverInfo = server.listen(8080)
println("\nServer started: #{serverInfo.message}")
println("Listening on: #{serverInfo.address}")

println("\nâœ“ All HTTP improvements tests passed!")
println("Server is running. You can test endpoints like:")
println("  GET  http://localhost:8080/ok")
println("  GET  http://localhost:8080/admin")
println("  POST http://localhost:8080/users")
println("  GET  http://localhost:8080/not-found")
println("  GET  http://localhost:8080/custom-error")

// Keep the server running
Sys.sleep(60000)
