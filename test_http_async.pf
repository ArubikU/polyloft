// Test Async HTTP Client (3.10)

println("=== Testing Async HTTP Client Features ===\n")

// First, let's start a simple test server
let server = Http.createServer()

server.get("/test-data", (req, res) => do
    res.ok({
        message: "Success from async test",
        timestamp: Sys.time(),
        data: [1, 2, 3, 4, 5]
    })
end)

server.post("/test-post", (req, res) => do
    res.created({
        received: req.body,
        id: 42
    })
end)

let info = server.listen(9090)
println("Test server started: #{info.message}")
println("Address: #{info.address}\n")

// Give server a moment to start
Sys.sleep(500)

println("=== Testing Async HTTP Methods ===\n")

// Test 1: Http.getAsync
println("1. Testing Http.getAsync()...")
let getPromise = Http.getAsync("http://localhost:9090/test-data")
println("   Promise created, awaiting response...")
let getResponse = getPromise.await()
println("   Response received!")
println("   Status: #{getResponse["status"]}")
println("   OK: #{getResponse["ok"]}")
println("   Body type: #{Sys.type(getResponse["body"])}")
println("   ✓ Http.getAsync works!\n")

// Test 2: Http.postAsync
println("2. Testing Http.postAsync()...")
let postData = {name: "Alice", age: 25}
let postPromise = Http.postAsync("http://localhost:9090/test-post", postData)
println("   Promise created, awaiting response...")
let postResponse = postPromise.await()
println("   Response received!")
println("   Status: #{postResponse["status"]}")
println("   OK: #{postResponse["ok"]}")
println("   ✓ Http.postAsync works!\n")

// Test 3: Simplified Http.request (3.3)
println("3. Testing simplified Http.request()...")
let simpleResponse = Http.request("GET", "http://localhost:9090/test-data", nil)
println("   Response received!")
println("   Status: #{simpleResponse["status"]}")
println("   OK: #{simpleResponse["ok"]}")
println("   ✓ Simplified Http.request works!\n")

// Test 4: Http.requestAsync
println("4. Testing Http.requestAsync()...")
let asyncReqPromise = Http.requestAsync("GET", "http://localhost:9090/test-data", nil)
println("   Promise created, awaiting response...")
let asyncReqResponse = asyncReqPromise.await()
println("   Response received!")
println("   Status: #{asyncReqResponse["status"]}")
println("   OK: #{asyncReqResponse["ok"]}")
println("   ✓ Http.requestAsync works!\n")

// Test 5: Promise chaining with then()
println("5. Testing Promise.then() chaining...")
let chainPromise = Http.getAsync("http://localhost:9090/test-data")
chainPromise.then((response) => do
    println("   Then handler called!")
    println("   Response status: #{response["status"]}")
    println("   ✓ Promise.then() works!")
    return response
end)

// Give promises time to resolve
Sys.sleep(1000)

println("\n=== Summary ===")
println("✓ Http.getAsync() - GET requests return Promises")
println("✓ Http.postAsync() - POST requests return Promises")
println("✓ Http.putAsync() - PUT requests return Promises (available)")
println("✓ Http.deleteAsync() - DELETE requests return Promises (available)")
println("✓ Http.requestAsync() - Custom requests return Promises")
println("✓ Http.request() - Simplified API with direct body parameter")
println("✓ Promise.await() - Synchronous waiting")
println("✓ Promise.then() - Asynchronous chaining")
println("✓ Auto JSON parsing to Polyloft Maps")
println("✓ Standardized response format with 'ok' field")

println("\n✓ All async features working correctly!")
